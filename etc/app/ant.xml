<project name="blason-runner" basedir="." default="release">

    <!-- DO NOT EDIT THIS FILE, IT IS MAINTAINED BY THE
          FRAMEWORK
    -->

    <scriptdef name="generateguid" language="javascript">
        <attribute name="property" />
        <![CDATA[
        importClass( java.util.UUID );
        project.setProperty( attributes.get( "property" ), UUID.randomUUID() );
        ]]>
    </scriptdef>
    <generateguid property="uuid" />

    <!--
    <taskdef name="uuid" className="org.apache.commons.id.uuid.task.UUIDTask"/>
    <uuid version="VERSION_FIVE"/> 
    <property name="my.guid" value="77c02546-8e96-4687-949f-9461ee6a21de"/>
    -->
    <taskdef resource="net/sf/antcontrib/antlib.xml"/>

    <property environment="env"/>
    <property name="blason.home" value="${env.BLASON_HOME}" />
    <property name="apps.dir" value="${blason.home}/apps" />
    <property name="pods.dir" value="${blason.home}/pods" />

    <propertyregex property="app.domain.path" input="${blason.app.domain}"
        regexp="\." replace="/" global="true" defaultValue="${blason.app.domain}"/>
    <property name="app.dir" value="${apps.dir}/${blason.appid}" />

    <condition property="os.windows">
        <os name="windows"/>
    </condition>

    <!--
    <property name="webapps.dir" value="${app.dir}/webapps" />
    <property name="webinf.dir" value="${webapps.dir}/WEB-INF" />
    <property name="webb.dir" value="${webinf.dir}/lib" />
    <property name="webx.dir" value="${webinf.dir}/web.xml" />
    <property name="tmp.dir" value="${app.dir}/tmp" />
    <property name="war.dir" value="${tmp.dir}/packj2eewar"/>
    <available file="${webz.dir}/../"
        type="dir"
        property="webinf.detected"/>
    -->

    <available file="${app.dir}/src/main/groovy"   type="dir"   property="src.groovy"/>
    <available file="${app.dir}/src/main/scala"   type="dir"   property="src.scala"/>
    <available file="${app.dir}/src/main/java"   type="dir"   property="src.java"/>

    <property name="test.rpt.dir" value="${tmp.dir}/test-reports"/>
    <property name="test.cz.dir" value="${tmp.dir}/test-classes"/>
    <property name="cz.dir"  value="${app.dir}/POD-INF/classes" />

    <property name="webz.dir" value="${app.dir}/WEB-INF/classes" />
    <property name="podz.dir" value="${cz.dir}" />


    <path id="compile.classpath">
        <fileset dir="${app.dir}/POD-INF/lib">
            <include name="**/*.jar"/>
        </fileset>
        <fileset dir="${blason.home}/patch">
            <include name="**/*.jar"/>
        </fileset>
        <fileset dir="${blason.home}/dist">
            <include name="**/*.jar"/>
        </fileset>
        <fileset dir="${blason.home}/lib">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <path id="compile.test.classpath">
        <pathelement path="${test.cz.dir}"/>
        <pathelement path="${cz.dir}"/>
        <path refid="compile.classpath"/>
    </path>

    <target name="release" depends="">
        <echo message="hello world"/>
    </target>

    <target name="clean" depends="clean-classes">
    </target>
    <target name="clean-classes">
        <delete dir="${webz.dir}" quiet="true" failonerror="false"/>
        <delete dir="${cz.dir}" quiet="true" failonerror="false"/>
        <mkdir dir="${cz.dir}"/>
    </target>

    <target name="compile-test-code" depends="compile-code">
        <delete dir="${test.rpt.dir}" quiet="true"/>
        <delete dir="${test.cz.dir}" quiet="true"/>
        <mkdir dir="${test.rpt.dir}"/>
        <mkdir dir="${test.cz.dir}"/>
        <antcall target="ct-j"></antcall>
        <antcall target="ct-g"></antcall>
        <antcall target="ct-s"></antcall>
    </target>

    <target name="compile-code" depends="clean-classes">
      <taskdef name="groovyc"    classname="org.codehaus.groovy.ant.Groovyc"    classpathref="compile.classpath"/>
      <taskdef name="scalac"    classname="scala.tools.ant.Scalac"   classpathref="compile.classpath"/>
        <antcall target="cc-j"></antcall>
        <antcall target="cc-g"></antcall>
        <antcall target="cc-s"></antcall>
    </target>

    <target name="cc-j" depends="" if="src.java">
        <javac destdir="${cz.dir}" srcdir="${app.dir}/src/main/java"
            includeAntRuntime="false" debug="on" debuglevel="lines,vars,source" >
            <classpath refid="compile.classpath"/>
        </javac>
        <copy todir="${cz.dir}">
            <fileset dir="${app.dir}/src/main/java">
              <exclude name="**/*.java"/>
              <exclude name="**/.svn"/>
            </fileset>
        </copy>
    </target>

    <target name="ct-j" depends="" if="src.java">
        <javac destdir="${test.cz.dir}" srcdir="${app.dir}/src/test/java"
            includeAntRuntime="false" debug="on" debuglevel="lines,vars,source" >
            <classpath refid="compile.test.classpath"/>
        </javac>
        <copy todir="${test.cz.dir}">
            <fileset dir="${app.dir}/src/test/java">
                <exclude name="**/*.java"/>
                <exclude name="**/.svn"/>
            </fileset>
        </copy>
    </target>

    <target name="cc-g" depends="" if="src.groovy">
        <groovyc destdir="${cz.dir}" srcdir="${app.dir}/src/main/groovy" >
            <classpath refid="compile.classpath"/>
        </groovyc>
        <copy todir="${cz.dir}">
            <fileset dir="${app.dir}/src/main/groovy">
              <exclude name="**/*.groovy"/>
              <exclude name="**/.svn"/>
            </fileset>
        </copy>
    </target>

    <target name="ct-g" depends="" if="src.groovy">
        <groovyc destdir="${test.cz.dir}" srcdir="${app.dir}/src/test/groovy" >
            <classpath refid="compile.test.classpath"/>
        </groovyc>
        <copy todir="${test.cz.dir}">
            <fileset dir="${app.dir}/src/test/groovy">
                <exclude name="**/*.groovy"/>
                <exclude name="**/.svn"/>
            </fileset>
        </copy>
    </target>

    <target name="cc-s" depends="" if="src.scala">
        <scalac destdir="${cz.dir}" srcdir="${app.dir}/src/main/scala"
            classpathref="compile.classpath">
            <include name="**/*.scala"/>
        </scalac>
        <copy todir="${cz.dir}">
            <fileset dir="${app.dir}/src/main/scala">
              <exclude name="**/*.scala"/>
              <exclude name="**/.svn"/>
            </fileset>
        </copy>
    </target>

    <target name="ct-s" depends="" if="src.scala">
        <scalac destdir="${test.cz.dir}" srcdir="${app.dir}/src/test/scala"
            classpathref="compile.test.classpath">
            <include name="**/*.scala"/>
        </scalac>
        <copy todir="${test.cz.dir}">
            <fileset dir="${app.dir}/src/test/scala">
                <exclude name="**/*.scala"/>
                <exclude name="**/.svn"/>
            </fileset>
        </copy>
    </target>

    <target name="jar" depends="">
      <jar destfile="${app.dir}/POD-INF/lib${app.name}.jar" basedir="${cz.dir}"/>
      <delete dir="${cz.dir}"/>
      <mkdir dir="${cz.dir}"/>
    </target>

    <target name="run-app-bg-nix" depends="">
        <exec executable="${blason.home}/bin/blason" dir="${blason.home}">
            <arg value="app"/>
            <arg value="start"/>
            <arg value="bg"/>
        </exec>
    </target>

    <target name="run-app-bg-w32" depends="">
        <exec executable="cmd.exe" dir="${blason.home}">
            <arg value="/C"/>
            <arg value="start"/>
            <arg value="/B"/>
            <arg value="/MIN"/>
            <arg value="${blason.home}/bin/blason.bat"/>
            <arg value="start"/>
        </exec>
    </target>

    <target name="run-dbg-app-w32" depends="">
        <exec executable="${blason.home}/bin/blason.bat" dir="${blason.home}">
            <arg value="debug"/>
        </exec>
    </target>

    <target name="run-dbg-app-nix" depends="">
        <exec executable="${blason.home}/bin/blason" dir="${blason.home}">
            <arg value="debug"/>
        </exec>
    </target>

    <target name="test-code" depends="compile-test-code">
        <junit logfailedtests="true" showoutput="false" printsummary="yes" fork="yes" haltonfailure="yes" >
            <classpath refid="compile.test.classpath"/>
            <batchtest todir="${test.rpt.dir}" >
                <fileset dir="${test.cz.dir}">
                    <include name="**/Test*.*"/>
                </fileset>
                <formatter type="plain" usefile="false"/>
            </batchtest>
        </junit>
    </target>

    <target name="create-demo" if="demo.id">
      <available file="${blason.home}/docs/samples/${demo.id}.pod" property="demo.pod.ok"/>
      <if><equals arg1="${demo.pod.ok}" arg2="true"/>
        <then>
          <mkdir dir="${apps.dir}/demo-${demo.id}"/>
          <unzip src="${blason.home}/docs/samples/${demo.id}.pod" dest="${apps.dir}/demo-${demo.id}" />
        </then>
        <else>
          <echo message="Cannot locate ${demo.id}.pod."/>
        </else>
      </if>
    </target>

    <target name="create-samples">
      <for param="pod">
        <path>
          <fileset dir="${blason.home}/docs/samples">
            <include name="*.pod"/>
          </fileset>
        </path>
        <sequential>
          <var name="appid" value="" unset="true"/>
          <basename property="appid" file="@{pod}" suffix=".pod"/>
          <mkdir dir="${apps.dir}/demo-${appid}"/>
          <unzip src="@{pod}" dest="${apps.dir}/demo-${appid}" />
        </sequential>
      </for>
    </target>

    <target name="create-app">
      <mkdir dir="${app.dir}"/>
      <mkdir dir="${app.dir}/POD-INF/classes"/>
      <mkdir dir="${app.dir}/POD-INF/patch"/>
      <mkdir dir="${app.dir}/POD-INF/lib"/>
      <mkdir dir="${app.dir}/META-INF"/>
      <copy todir="${app.dir}/META-INF" file="${blason.home}/etc/app/MANIFEST.MF"/>
      <touch file="${app.dir}/META-INF/RELEASE-NOTES.txt" />
      <touch file="${app.dir}/META-INF/NOTES.txt" />
      <touch file="${app.dir}/META-INF/LICENSE.txt" />
      <touch file="${app.dir}/META-INF/README.md" />
      <mkdir dir="${app.dir}/conf"/>
      <copy todir="${app.dir}/conf" file="${blason.home}/etc/app/app.conf"/>
      <copy todir="${app.dir}/conf" file="${blason.home}/etc/app/env.conf"/>
      <replace file="${app.dir}/conf/app.conf" token="@@APPKEY@@" value="${uuid}"/>
      <mkdir dir="${app.dir}/src/main/scala/${app.domain.path}"/>
      <mkdir dir="${app.dir}/src/main/java"/>
      <mkdir dir="${app.dir}/src/main/resources"/>
      <copy todir="${app.dir}/src/main/scala/${app.domain.path}" file="${blason.home}/etc/app/AppMain.scala"/>
      <copy todir="${app.dir}/src/main/scala/${app.domain.path}" file="${blason.home}/etc/app/Handler.scala"/>
      <mkdir dir="${app.dir}/src/test/scala/${app.domain.path}"/>
      <mkdir dir="${app.dir}/docs"/>

      <copy todir="${app.dir}" file="${blason.home}/etc/app/build.properties"/>
      <copy todir="${app.dir}" file="${blason.home}/etc/app/build.xml"/>
      <copy todir="${app.dir}" file="${blason.home}/etc/app/ivysettings.xml"/>
      <copy todir="${app.dir}" file="${blason.home}/etc/app/ivy.xml"/>
      <copy todir="${app.dir}" file="${blason.home}/etc/app/pom.xml"/>

      <replace file="${app.dir}/META-INF/MANIFEST.MF" token="@@APPDOMAIN@@" value="${blason.app.domain}"/>
      <replace file="${app.dir}/pom.xml" token="@@APPDOMAIN@@" value="${blason.app.domain}"/>
      <replace file="${app.dir}/pom.xml" token="@@APPID@@" value="${blason.appid}"/>
      <replace file="${app.dir}/ivy.xml" token="@@APPID@@" value="${blason.appid}"/>
      <replace file="${app.dir}/ivy.xml" token="@@APPDOMAIN@@" value="${blason.app.domain}"/>
      <replace file="${app.dir}/build.properties" 
        token="@@BLASONHOME@@" value="${blason.home}"/>
      <replace file="${app.dir}/build.xml" token="@@APPID@@" value="${blason.appid}"/>

      <replace file="${app.dir}/src/main/scala/${app.domain.path}/AppMain.scala" 
        token="@@APPDOMAIN@@" value="${blason.app.domain}"/>
      <replace file="${app.dir}/src/main/scala/${app.domain.path}/Handler.scala" 
        token="@@APPDOMAIN@@" value="${blason.app.domain}"/>
      <replace file="${app.dir}/conf/env.conf" token="@@APPDOMAIN@@" value="${blason.app.domain}"/>
    </target>

    <target name="create-jetty">
      <antcall target="create-app"/>
      <antcall target="create-web-common"/>
      <mkdir dir="${app.dir}/WEB-INF/classes"/>
      <mkdir dir="${app.dir}/WEB-INF/lib"/>
      <copy tofile="${app.dir}/conf/env.conf" file="${blason.home}/etc/jetty/jetty.conf" overwrite="true"/>
      <copy todir="${app.dir}/WEB-INF" file="${blason.home}/etc/jetty/web.xml"/>
    </target>

    <target name="create-web">
      <antcall target="create-app"/>
      <antcall target="create-web-common"/>
      <copy todir="${app.dir}/conf" overwrite="true">
        <fileset dir="${blason.home}/etc/netty">
            <include name="*.conf"/>
        </fileset>
      </copy>
      <copy todir="${app.dir}/conf" file="${blason.home}/etc/netty/static-routes.conf" overwrite="true"/>
      <copy todir="${app.dir}/conf" file="${blason.home}/etc/netty/routes.conf" overwrite="true"/>
      <copy todir="${app.dir}/public/images" file="${blason.home}/etc/web/favicon.png"/>
      <mkdir dir="${app.dir}/pages/templates"/>
      <mkdir dir="${app.dir}/pages/views"/>
      <copy todir="${app.dir}/pages/templates" >
        <fileset dir="${blason.home}/etc/netty">
          <include name="index.html"/>
          <include name="*.html"/>
        </fileset>
      </copy>
      <copy todir="${app.dir}/public/styles" file="${blason.home}/etc/netty/main.css"/>
      <copy todir="${app.dir}/public" file="${blason.home}/etc/netty/index.html"/>
      <mkdir dir="${app.dir}/src/main/resources/coffee"/>
      <mkdir dir="${app.dir}/src/main/resources/js"/>
      <mkdir dir="${app.dir}/src/main/resources/less"/>
      <replace file="${app.dir}/conf/routes.conf" token="@@APPDOMAIN@@" value="${blason.app.domain}"/>
      <replace file="${app.dir}/conf/env.conf" token="@@APPDOMAIN@@" value="${blason.app.domain}"/>
    </target>

    <target name="create-web-common">
      <antcall target="create-app"/>
      <mkdir dir="${app.dir}/public/images"/>
      <mkdir dir="${app.dir}/public/scripts"/>
      <mkdir dir="${app.dir}/public/styles"/>
      <copy todir="${app.dir}/public/images" file="${blason.home}/etc/web/favicon.png"/>
      <copy todir="${app.dir}/src/main/scala/${app.domain.path}" 
        file="${blason.home}/etc/web/Handler.scala" overwrite="true"/>
      <replace file="${app.dir}/src/main/scala/${app.domain.path}/Handler.scala" 
        token="@@APPDOMAIN@@" value="${blason.app.domain}"/>
      <copy todir="${app.dir}/public">
        <fileset dir="${blason.home}/etc/weblibs"/>
      </copy>

    </target>

    <target name="build-app" if="blason.appid">
      <ant antfile="build.xml" dir="${app.dir}" target="${blason.app.task}"
        useNativeBasedir="true" inheritAll="false"/>
    </target>

    <target name="bundle-app">
      <antcall target="build-app"/>
      <zip  destfile="${pods.dir}/${blason.appid}.pod">
        <fileset dir="${app.dir}">
          <exclude name="build.output.*"/>
        </fileset>
      </zip>
    </target>


</project>


